=encoding utf8

=head1 NAME

Quiq::MediaWiki::Client - Clientseitiger Zugriff auf ein MediaWiki

=head1 BASE CLASS

L<Quiq::Hash|https://github.com/s31tz/Quiq/tree/master/pod/class/Quiq/Hash.pod>

=head1 DESCRIPTION

Diese Klasse implementiert Methoden zur Kommunikation mit einem
MediaWiki über die sogenannte MediaWiki-API.

Die MediaWiki-API wird über api.php (statt index.php) angesprochen.
Die Doku der API wird angezeigt, wenn api.php ohne Parameter
oder mit "action=help&recursivesubmodules=1" (alles auf einer Seite)
aufgerufen wird.

Die MediaWiki-API empfängt und liefert alle Daten in UTF-8.

Insbesondere implementiert die Klasse die Methode $mw->L</load>(), mit
welcher sowohl Seiten als auch Mediendateien (z.B. Bilder)
"intelligent" geladen werden können.

Bei Angabe der Option -debug => 1 bei Aufruf des Konstruktors
wird die gesamte Kommunikation auf STDERR protokolliert.

=head1 SEE ALSO

=over 2

=item *

L<API Dokumentation|https://www.mediawiki.org/wiki/API> (www.mediawiki.org)

=item *

L<API Lowlevel-Dokumentation|https://www.mediawiki.org/w/api.php?action=help&recursivesubmodules=1>
(www.mediawiki.org)

=item *

Client-Implementierung: quik-mediawiki

=back

=head1 EXAMPLES

Beispiele für MediaWiki URLs:

=over 2

=item *

L<https://www.mediawiki.org/w/api.php>

=item *

L<http://localhost/mediawiki/api.php>
(nicht allgemein aufrufbar)

=item *

L<http://lxv0103.ruv.de:8080/api.php>
(nicht allgemein aufrufbar)

=back

=head1 METHODS

=head2 Konstruktor

=head3 new() - Instantiiere MediaWiki-API Client

=head4 Synopsis

    $mw = $class->new($url,@opt);
    $mw = $class->new($url,$user,$password,@opt);

=head4 Arguments

=over 4

=item $url

API-URL des MediaWiki, z.B. L<https://en.wikipedia.org/w/api.php>.

=item $user

Benutzername (für automatisches Login statt explizites Login).

=item $password

Passwort (für automatisches Login statt explizites Login).

=back

=head4 Options

=over 4

=item -color => $bool (Default: 1)

Gib die Laufzeitinformation (wird mit -debug=>1 eingeschaltet)
in Farbe aus.

=item -debug => $bool (Default: 0)

Gib Laufzeit-Information wie den Kommunikationsverlauf auf STDERR aus.

=back

=head4 Returns

Client-Objekt (Referenz)

=head4 Description

Instantiiere einen Client für die MediaWiki-API $url und liefere eine
Referenz auf dieses Objekt zurück.

Der Konstruktor-Aufruf löst I<keinen> Server-Request aus. Sind
$user und $password angegeben, wird der Benutzer erst mit dem
ersten Token-Request eingeloggt. Er wird also nur eingeloggt, wenn
es nötig ist. Vorteil: Ein Client, bei dem sich erst im Laufe der
Ausführung herausstellt, ob er Requests ausführt, muss nicht vorab
einen - ggf.  unnötigen - Login-Request ausführen. (De facto besteht
ein Login-Request aus zwei Requests, da mit dem ersten Aufruf
lediglich der Login-Token geliefert wird.) Solange der Client
Requests ausführt, die kein Login benötigen, werden diese beiden
Requests ebenfalls gespart.

Bei Angabe der Option -debug => 1 bei Aufruf des Konstruktors
wird die gesamte Kommunikation auf STDERR protokolliert.

=head2 Grundlegende Operationen

=head3 login() - Logge Nutzer ein

=head4 Synopsis

    $res = $mw->login($user,$password);

=head4 Arguments

=over 4

=item $user

Name des Nutzers

=item $password

Passwort des Nutzers

=back

=head4 Returns

Response (Hash-Referenz)

=head4 Description

Melde den Benutzer $user mit Passwort $password auf dem
MediaWiki-Server an. Alternativ ist ein automatisches Login
möglich, was eleganter ist. Siehe Konstruktor.

=head4 Example

    $ perl -MQuiq::MediaWiki::Client -E 'Quiq::MediaWiki::Client->new("http://lxv0103.ruv.de:8080/api.php",-debug=>1)->login("XV882JS","<PASSWORD>")'

=head3 getToken() - Besorge Token für Operation

=head4 Synopsis

    $token = $mw->getToken($action);

=head4 Arguments

=over 4

=item $action

Operation, für die das Token benötigt wird.

=back

=head4 Returns

Token (String)

=head4 Description

Besorge vom Server ein Token zum Ausführen von Operation $action und
liefere dieses zurück. Da das Token je Session für alle Seiten identisch
ist, cachen wir die Tokens, so dass nur eine Serveranfrage nötig ist.

=head3 version() - Versionsnummer MediaWiki-Server

=head4 Synopsis

    $version = $mw->version;

=head4 Description

Ermittele die Versionsnummer des MediaWiki-Servers und liefere
diese zurück. Die Information wird im Objekt gecached.

=head3 getPage() - Liefere Seite

=head4 Synopsis

    $pag = $mw->getPage($pageId,@opt);
    $pag = $mw->getPage($title,@opt);

=head4 Arguments

=over 4

=item $pageId

Page-Id der Seite.

=item $title

Titel der Seite.

=back

=head4 Options

=over 4

=item -sloppy => $bool (Default: 0)

Wirf keine Exception, wenn die Seite nicht gefunden wird, sondern
liefere undef.

=back

=head4 Returns

Page-Objekt (Hash-Referenz)

=head4 Description

Ermittele die Seite mit der Page-Id $pageId bzw. dem Titel $title und
liefere diese zurück. Die Methode erkennt eine Page-Id daran, dass
der Wert ausschließlich aus Ziffern besteht. Alles andere wird als
Seitentitel interpretiert.

Der geliefere Hash besitzt folgende Komponenten, die auch per
Accessor-Methode abgefragt werden können:

=over 2

=item *

=over 2

=item *

(= Inhalt der Seite)

=back

=item *

comment

=item *

contentformat

=item *

contentmodel

=item *

ns

=item *

pageid

=item *

parentid

=item *

revid

=item *

size

=item *

timestamp

=item *

title

=item *

user

=back

=head3 editPage() - Erzeuge/ändere Seite

=head4 Synopsis

    $res = $mw->editPage($pageId,$text); # [1]
    $res = $mw->editPage($title,$text);  # [2]

=head4 Arguments

=over 4

=item $pageId

Page-Id der Seite.

=item $title

Titel der Seite.

=item $text

Text der Seite

=back

=head4 Returns

Response (Hash-Referenz)

=head4 Description

Dies ist die Lowlevel-Methode zum Speichern einer Seite oder
des Contents einer Seite. Eine weitergehende Logik, die auch
Titelnderungen erlaubt, implementiert die  Methode $mw->L</load>().

In Fassung [1] wird der Content der Seite mit der Page-Id $pageId
auf Text $text gesetzt. Die Seite muss existieren.

In Fassung [2] muss die Seite nicht existieren.  Der MediaWiki-Server
implementiert folgende Logik:

=over 2

=item *

Existiert die Seite nicht, wird sie angelegt.

=item *

Existiert die Seite und ist der Text verschieden, wird der
bestehende Text ersetzt.

=item *

Existiert die Seite und ist der Text identisch, wird der
Aufruf vom Wiki-Server ignoriert.

=back

=head3 movePage() - Benenne Seite um

=head4 Synopsis

    $res = $mw->movePage($pageId,$newTitle,@opt);
    $res = $mw->movePage($oldTitle,$newTitle,@opt);

=head4 Arguments

=over 4

=item $pageId

Page-Id der Seite.

=item $oldTitle

Titel der Seite.

=item $newTitle

Zukünftiger Titel der Seite.

=back

=head4 Options

=over 4

=item -reason => $text

Grund für die Umbenennung.

=item -redirect => $bool (Default: 1)

Erzeuge ein Redirekt von der alten zur neuen Seite. Wird
-redirect => 0 gesetzt, unterbleibt dies.

=back

=head4 Returns

Response (Hash-Referenz)

=head4 Description

Benenne die Seite mit Page-Id $pageId oder dem Titel $oldTitle
in $newTitle um. Die alte Seite existiert weiterhin. Das Wiki
richtet automatisch eine Umleitung von der alten zur neuen
Seite ein, sofern beim Aufruf nicht -redirect => 0 angegeben wird.

=head3 siteInfo() - Allgemeine Information über das MediaWiki

=head4 Synopsis

    $res = $mw->siteInfo;
    $res = $mw->siteInfo(@properties);

=head4 Arguments

=over 4

=item @properties

Liste der Sysinfo-Properties, die abgefragt werden sollen. Sind keine
Properties angegeben, werden alle (zur Zeit der Implementierung
bekannten) Properties abgefragt.

=back

=head4 Returns

Response

=head4 Example

    $ quiq-mediawiki ruv statistics --debug

=head3 upload() - Lade Datei hoch

=head4 Synopsis

    $res = $mw->upload($file);

=head4 Arguments

=over 4

=item $file

Pfad der Datei.

=back

=head4 Returns

Response

=head4 Description

Lade die lokale Datei $file über die Upload-Schnittstelle ins
MediaWiki hoch. Dies ist typischerweise eine Bilddatei vom Typ
PNG, JPEG oder GIF.

=head4 See Also

=over 2

=item *

L<API:Upload|https://www.mediawiki.org/wiki/API:Upload>

=item *

L<File Upload per LWP|http://lwp.interglacial.com/ch05_07.htm>

=back

=pod
    # Datei hochladen (wir lesen $file selbst)

    my $p = Quiq::Path->new;
    my $data = $p->read($file);

    # Datei hochladen

    my $filename = $p->filename($file);
    return $self->send('POST','upload',
        token => $token,
        filename => $filename,
        file => [undef,$filename,Content=>$data],
    );
=head2 Kommunikation

=head3 load() - Lade Seite oder Bilddatei ins Wiki

=head4 Synopsis

    $mw->load($cacheDir,$file,@opt);

=head4 Arguments

=over 4

=item $cacheDir

Pfad zum Spiegel-Verzeichnis. Der Inhalt des Spiegel-Verzeichnisses wird
von der Methode verwaltet. Es enthält Kopien der geladenen Dateien.

=item $file

Pfad der Datei, die geladen werden soll. Dies kann eine Seitendatei
(*.mw) oder eine sonstige Datei sein (*.png, *.jpg, *.gif, ...),
die über die Upload-Schnittstelle des MediaWiki geladen werden kann.

=back

=head4 Description

# $cacheName
Name für die Seite im Spiegel-Verzeichnis. Dieser Name identifiziert die
Seite im Spiegel-Verzeichnis (und ist nicht zu verwechseln mit dem Titel
der Seite). Der Name $cacheName muss eindeutig sein.

Lade die Seite $input mit dem eindeutigen Namen $cacheName (im
Spiegel-Verzeichnis) ins MediaWiki. Der $cacheName ist nicht zu verwechseln
mit dem Titel der Seite. Der Titel der Seite ist zusammen mit
dem Inhalt der Seite Teil der externen Seitenrepräsentation $input.
Die Methode erkennt, ob die externe Seite $input

=over 2

=item *

bereits im Wiki existiert oder neu angelegt werden muss

=item *

sich der Titel geändert hat -> movePage()

=item *

sich der Inhalt gegenüber dem letzten Stand geändert hat -> editPage()

=item *

eine Änderung im Wiki erfahren hat und diese Änderung in die externe
Seite eingepflegt werden muss -> Fehlermeldung

=back

=head2 Kommunikation

=head3 send() - Sende HTTP-Anfrage, empfange HTTP-Antwort

=head4 Synopsis

    $res = $mw->send($method,$action,@keyVal);

=head4 Arguments

=over 4

=item $method

Die HTTP Request-Methode: 'GET' oder 'POST'.

=item $action

Die Aktion, die ausgeführt werden soll, z.B. 'query'.

=item @keyVal

Die Liste der Schlüssel/Wert-Paare, die an den Server übermittelt werden,
entweder als URL-Parameter im Falle von GET oder im Body des Requests
im Falle von POST.

=back

=head4 Returns

Dekodiertes JSON in UTF-8 als Perl-Hash

=head4 Description

Grundlegende Methode, über die sämtliche Interaktion mit dem
MediaWiki-Server läuft. Die Interaktion besteht in einem Austausch
von Schlüssel/Wert-Paaren via HTTP mittels GET oder POST. Der Client
sendet mit einem Request eine Menge von Schlüssel/Wert-Paaren und erhält
vom Server in der Response eine Menge von Schlüssel/Wert-Paaren zurück.
In beide Richtungen wird UTF-8 Encoding vorausgesetzt. D.h. die
@keyVal-Elemente müssen UTF-8 kodiert sein, die Elemente in der
Response $res sind es ebenfalls.

=head2 Response Handling

=head3 reduceToPage() - Reduziere Seitenliste auf Einzelseite

=head4 Synopsis

    $pag = $mw->reduceToPage($res);
    $pag = $mw->reduceToPage($res,$sloppy);

=head4 Arguments

=over 4

=item $res

Response vom Server mit Seitenliste.

=item $sloppy

Wirf keine Exception, wenn keine Seite existiert.

=back

=head4 Returns

Reduzierte Response

=head4 Description

Reduziere die Server-Response $res mit einer Seitenliste der Art

    {
        query => {
            pages => {
                $pageId => {
                     @keyVal
                },
                ...
            },
        }
    }

auf

    {
        @keyVal
    }

also auf ein Element und liefere dieses zurück.

Enthält die Seitenliste mehr als ein Element, oder handelt es sich um
ein ungültiges (als "missing" gekennzeichnetes) Element, wird eine
Exception geworfen.

=head2 Logging

=head3 log() - Schreibe Debug Log

=head4 Synopsis

    $mw->log($title,$text);

=head4 Description

Schreibe den Text $text unter der Überschrift $title nach STDERR.

=head1 VERSION

1.131

=head1 SOURCE

L<https://github.com/s31tz/Quiq/tree/master/lib/Quiq/MediaWiki/Client.pm>

=head1 AUTHOR

Frank Seitz, L<http://fseitz.de/>

=head1 COPYRIGHT

Copyright (C) 2019 Frank Seitz

=head1 LICENSE

This code is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.
